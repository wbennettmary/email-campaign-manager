{% extends "base.html" %}

{% block title %}Live Campaigns{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header with Controls -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-broadcast-tower text-primary"></i>
            Live Campaigns Monitor
        </h1>
        <div class="d-flex gap-2 align-items-center">
            <!-- Admin Controls -->
            {% if is_admin() %}
            <div class="dropdown me-3">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-cog"></i> Admin
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="showHiddenCampaignsCount()">
                        <i class="fas fa-eye-slash me-2"></i>Show Hidden Count
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="restoreHiddenCampaigns()">
                        <i class="fas fa-eye me-2"></i>Restore All Hidden
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="refreshCampaigns()">
                        <i class="fas fa-sync-alt me-2"></i>Force Refresh
                    </a></li>
                </ul>
            </div>
            {% endif %}
            
            <!-- Grid Controls -->
            <div class="d-flex align-items-center me-3">
                <label class="form-label mb-0 me-2">Grid:</label>
                <select class="form-select form-select-sm" id="gridSelector" style="width: auto;">
                    <option value="1">1 per row</option>
                    <option value="2" selected>2 per row</option>
                    <option value="3">3 per row</option>
                    <option value="4">4 per row</option>
                    <option value="6">6 per row</option>
                </select>
            </div>
            
            <!-- Auto-refresh Toggle -->
            <div class="form-check form-switch me-3">
                <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
                <label class="form-check-label" for="autoRefreshToggle">
                    Auto-refresh
                </label>
            </div>
            
            <!-- Refresh Interval -->
            <div class="d-flex align-items-center me-3">
                <label class="form-label mb-0 me-2">Interval:</label>
                <select class="form-select form-select-sm" id="refreshInterval" style="width: auto;">
                    <option value="5000">5s</option>
                    <option value="10000" selected>10s</option>
                    <option value="30000">30s</option>
                    <option value="60000">1m</option>
                </select>
            </div>
            
            <button class="btn btn-outline-primary" onclick="refreshCampaigns()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <a href="/campaigns" class="btn btn-primary">
                <i class="fas fa-plus"></i> Create Campaign
            </a>
        </div>
    </div>

    <!-- Filter Buttons -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="btn-group" role="group" aria-label="Campaign filters">
                <button type="button" class="btn btn-outline-primary active" id="filter-live" onclick="filterCampaigns('live')">
                    <i class="fas fa-play-circle"></i> Live Campaigns
                </button>
                <button type="button" class="btn btn-outline-warning" id="filter-interrupted" onclick="filterCampaigns('interrupted')">
                    <i class="fas fa-pause-circle"></i> Interrupted Campaigns
                </button>
                <button type="button" class="btn btn-outline-secondary" id="filter-finished" onclick="filterCampaigns('finished')">
                    <i class="fas fa-check-circle"></i> Old Finished Campaigns
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="text-center py-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading campaigns...</p>
    </div>

    <!-- Statistics Bar -->
    <div class="row mb-4" id="stats-container">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h4 class="mb-0" id="total-campaigns">{{ campaigns|length }}</h4>
                    <small>Total Active</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h4 class="mb-0" id="total-sent">{{ campaigns|sum(attribute='total_sent') or 0 }}</h4>
                    <small>Total Sent</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h4 class="mb-0" id="total-errors">0</h4>
                    <small>Total Errors</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h4 class="mb-0" id="total-remaining">
                        {% set total_recipients = 0 %}
                        {% set total_sent = 0 %}
                        {% for campaign in campaigns %}
                            {% if campaign.system_version == 'universal_v2' %}
                                {% set total_recipients = total_recipients + (campaign.total_attempted or 0) %}
                            {% else %}
                                {% set total_recipients = total_recipients + (campaign.destinataires.split('\n')|length) %}
                            {% endif %}
                            {% set total_sent = total_sent + (campaign.total_sent or 0) %}
                        {% endfor %}
                        {{ total_recipients - total_sent }}
                    </h4>
                    <small>Total Remaining</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Campaigns Grid -->
    <div id="campaigns-container">
        {% if campaigns %}
            <div class="row" id="campaigns-grid">
                {% for campaign in campaigns %}
                <div class="col-lg-6 col-xl-4 mb-4" data-campaign-id="{{ campaign.id }}">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">{{ campaign.name }}</h6>
                            <span class="badge {{ get_status_badge_class(campaign.status) }}">
                                {{ campaign.status.title() }}
                            </span>
                        </div>
                        
                        <div class="card-body d-flex flex-column">
                            <!-- Progress Stats -->
                            <div class="row text-center mb-3">
                                <div class="col-3">
                                    <div class="text-primary">
                                        <h5 class="mb-0" id="sent-{{ campaign.id }}">{{ campaign.total_sent or 0 }}</h5>
                                        <small>Sent</small>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="text-warning">
                                        <h5 class="mb-0" id="errors-{{ campaign.id }}">0</h5>
                                        <small>Errors</small>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="text-info">
                                        <h5 class="mb-0" id="remaining-{{ campaign.id }}">
                                            {% if campaign.system_version == 'universal_v2' %}
                                                {{ (campaign.total_attempted or 0) - (campaign.total_sent or 0) }}
                                            {% else %}
                                                {{ (campaign.destinataires.split('\n')|length) - (campaign.total_sent or 0) }}
                                            {% endif %}
                                        </h5>
                                        <small>Left</small>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="text-success">
                                        <h5 class="mb-0" id="progress-{{ campaign.id }}">
                                            {% if campaign.system_version == 'universal_v2' %}
                                                {% set total = campaign.total_attempted or 0 %}
                                            {% else %}
                                                {% set total = campaign.destinataires.split('\n')|length %}
                                            {% endif %}
                                            {% set sent = campaign.total_sent or 0 %}
                                            {% if total > 0 %}{{ (sent / total * 100)|round|int }}%{% else %}0%{% endif %}
                                        </h5>
                                        <small>Progress</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="progress mb-3" style="height: 8px;">
                                {% if campaign.system_version == 'universal_v2' %}
                                    {% set total = campaign.total_attempted or 0 %}
                                {% else %}
                                    {% set total = campaign.destinataires.split('\n')|length %}
                                {% endif %}
                                {% set sent = campaign.total_sent or 0 %}
                                {% set progress = (sent / total * 100) if total > 0 else 0 %}
                                <div class="progress-bar bg-success" id="progress-bar-{{ campaign.id }}" role="progressbar" style="width: {{ progress }}%"></div>
                            </div>
                            
                            <!-- Live Logs -->
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-2">
                                    <i class="fas fa-terminal"></i> Recent Activity
                                </h6>
                                <div class="border rounded p-2" style="height: 120px; overflow-y: auto; background-color: #f8f9fa; font-size: 0.8rem;" id="logs-{{ campaign.id }}">
                                    {% if campaign.logs and campaign.logs|length > 0 %}
                                        {% for log in campaign.logs[-5:] %}
                                        <div class="activity-entry mb-1 p-1 rounded">
                                            {% if log.status == 'success' %}
                                                <span class="text-success fw-bold">‚úì</span>
                                                <span class="text-success">Email {{ log.email or 'recipient' }} {{ log.total_sent or 1 }}/{{ log.total_attempted or 1 }} done</span>
                                            {% elif log.status == 'error' %}
                                                <span class="text-danger fw-bold">‚úó</span>
                                                <span class="text-danger">Email {{ log.email or 'recipient' }} {{ log.total_sent or 0 }}/{{ log.total_attempted or 1 }} error</span>
                                                {% if log.message %}
                                                    <br><small class="text-muted">{{ log.message }}</small>
                                                {% endif %}
                                            {% elif 'rate limit' in log.message.lower() or '429' in log.message %}
                                                <span class="text-primary fw-bold">‚è±</span>
                                                <span class="text-primary">Rate limit exceeded - waiting...</span>
                                            {% elif log.status == 'info' and 'started' in log.message.lower() %}
                                                <span class="text-info fw-bold">üöÄ</span>
                                                <span class="text-info">{{ log.message }}</span>
                                            {% elif log.status == 'info' and 'completed' in log.message.lower() %}
                                                <span class="text-success fw-bold">üèÅ</span>
                                                <span class="text-success">{{ log.message }}</span>
                                            {% else %}
                                                <span class="text-secondary fw-bold">‚Ñπ</span>
                                                <span class="text-secondary">{{ log.message }}</span>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted text-center">
                                            <i class="fas fa-info-circle"></i>
                                            <br>No activity yet
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Campaign Details -->
                            <div class="mt-3">
                                <div class="small text-muted">
                                    <div><strong>Account:</strong> <span id="account-name-{{ campaign.id }}">Loading...</span></div>
                                    <div><strong>Template:</strong> {{ campaign.template_id }}</div>
                                    <div><strong>Started:</strong> {{ campaign.started_at[:19] if campaign.started_at else 'N/A' }}</div>
                                    {% if campaign.completed_at %}
                                    <div><strong>Completed:</strong> {{ campaign.completed_at[:19] }}</div>
                                    {% endif %}
                                </div>
                                
                                <!-- Campaign Actions -->
                                <div class="d-flex gap-1 mt-2">
                                    {% if campaign.status == 'running' %}
                                        <button class="btn btn-warning btn-sm" onclick="pauseCampaign({{ campaign.id }})" title="Pause Campaign">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="stopCampaign({{ campaign.id }})" title="Stop Campaign">
                                            <i class="fas fa-stop"></i>
                                        </button>
                                    {% elif campaign.status == 'paused' %}
                                        <button class="btn btn-success btn-sm" onclick="resumeCampaign({{ campaign.id }})" title="Resume Campaign">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="stopCampaign({{ campaign.id }})" title="Stop Campaign">
                                            <i class="fas fa-stop"></i>
                                        </button>
                                    {% elif campaign.status == 'ready' %}
                                        <button class="btn btn-success btn-sm" onclick="startCampaign({{ campaign.id }})" title="Start Campaign">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    {% endif %}
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteCampaign({{ campaign.id }})" title="Hide from Live View">
                                        <i class="fas fa-eye-slash"></i>
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm" onclick="clearLogs({{ campaign.id }})" title="Clear Logs">
                                        <i class="fas fa-eraser"></i>
                                    </button>
                                    <a href="/campaigns/{{ campaign.id }}/edit" class="btn btn-outline-secondary btn-sm" title="Edit Campaign">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-broadcast-tower fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No Active Campaigns</h4>
                <p class="text-muted">There are currently no running or recently completed campaigns.</p>
                <a href="/campaigns" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Create Your First Campaign
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Notification Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="notification-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-bell text-primary me-2"></i>
            <strong class="me-auto">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-message">
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
const socket = io();
let campaignLogs = {};
let hiddenCampaigns = new Set();

// Initialize logs for each campaign
{% for campaign in campaigns %}
campaignLogs[{{ campaign.id }}] = {{ campaign.logs|tojson }};
{% endfor %}

// Real-time update variables
let autoRefreshInterval;
let currentFilter = 'live';
let isRefreshing = false;

// Start auto-refresh functionality
function startAutoRefresh() {
    const autoRefreshToggle = document.getElementById('autoRefreshToggle');
    const refreshInterval = document.getElementById('refreshInterval');
    
    if (autoRefreshToggle && autoRefreshToggle.checked) {
        const interval = parseInt(refreshInterval ? refreshInterval.value : 10000);
        
        // Clear any existing interval
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
        
        autoRefreshInterval = setInterval(() => {
            if (!isRefreshing) {
                updateLiveCampaigns();
            }
        }, interval);
    }
}

// Stop auto-refresh
function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// Update live campaigns data without page refresh
function updateLiveCampaigns() {
    if (isRefreshing) return;
    
    isRefreshing = true;
    
    // Update only running campaigns that are not hidden
    const runningCampaigns = document.querySelectorAll('[data-campaign-id]');
    
    runningCampaigns.forEach(campaignCard => {
        const campaignId = campaignCard.getAttribute('data-campaign-id');
        
        // Skip hidden campaigns
        if (hiddenCampaigns.has(parseInt(campaignId))) {
            return;
        }
        
        const statusBadge = campaignCard.querySelector('.badge');
        const status = statusBadge ? statusBadge.textContent.toLowerCase().trim() : '';
        
        // Only update running campaigns
        if (status === 'running') {
            updateCampaignData(campaignId);
        }
    });
    
    // Update statistics (excluding hidden campaigns)
    updateStatistics();
    
    isRefreshing = false;
}

// Update individual campaign data
function updateCampaignData(campaignId) {
    fetch(`/api/campaigns/${campaignId}`)
        .then(response => response.json())
        .then(campaign => {
            // Update sent count
            const sentElement = document.getElementById(`sent-${campaignId}`);
            if (sentElement) {
                sentElement.textContent = campaign.total_sent || 0;
            }
            
            // Update remaining count
            const remainingElement = document.getElementById(`remaining-${campaignId}`);
            if (remainingElement) {
                let total = 0;
                if (campaign.system_version === 'universal_v2') {
                    total = campaign.total_attempted || 0;
                } else {
                    total = campaign.destinataires ? campaign.destinataires.split('\n').length : 0;
                }
                const sent = campaign.total_sent || 0;
                remainingElement.textContent = Math.max(0, total - sent);
            }
            
            // Update progress
            const progressElement = document.getElementById(`progress-${campaignId}`);
            const progressBar = document.getElementById(`progress-bar-${campaignId}`);
            if (progressElement && progressBar) {
                let total = 0;
                if (campaign.system_version === 'universal_v2') {
                    total = campaign.total_attempted || 0;
                } else {
                    total = campaign.destinataires ? campaign.destinataires.split('\n').length : 0;
                }
                const sent = campaign.total_sent || 0;
                const progress = total > 0 ? Math.round((sent / total) * 100) : 0;
                
                progressElement.textContent = `${progress}%`;
                progressBar.style.width = `${progress}%`;
            }
            
            // Update logs
            updateCampaignLogs(campaignId);
        })
        .catch(error => {
            console.error(`Error updating campaign ${campaignId}:`, error);
        });
}

// Update campaign logs
function updateCampaignLogs(campaignId) {
    fetch(`/api/campaigns/${campaignId}/logs`)
        .then(response => response.json())
        .then(logs => {
            const logsContainer = document.getElementById(`logs-${campaignId}`);
            if (logsContainer && logs.length > 0) {
                // Get the last 5 logs
                const recentLogs = logs.slice(-5);
                let logsHTML = '';
                
                recentLogs.forEach(log => {
                    if (log.status === 'success') {
                        logsHTML += `
                            <div class="activity-entry mb-1 p-1 rounded">
                                <span class="text-success fw-bold">‚úì</span>
                                <span class="text-success">Email ${log.email || 'recipient'} ${log.total_sent || 1}/${log.total_attempted || 1} done</span>
                            </div>
                        `;
                    } else if (log.status === 'error') {
                        logsHTML += `
                            <div class="activity-entry mb-1 p-1 rounded">
                                <span class="text-danger fw-bold">‚úó</span>
                                <span class="text-danger">Email ${log.email || 'recipient'} ${log.total_sent || 0}/${log.total_attempted || 1} error</span>
                                ${log.message ? `<br><small class="text-muted">${log.message}</small>` : ''}
                            </div>
                        `;
                    } else if (log.message && (log.message.toLowerCase().includes('rate limit') || log.message.includes('429'))) {
                        logsHTML += `
                            <div class="activity-entry mb-1 p-1 rounded">
                                <span class="text-primary fw-bold">‚è±</span>
                                <span class="text-primary">Rate limit exceeded - waiting...</span>
                            </div>
                        `;
                    } else if (log.status === 'info' && log.message && log.message.toLowerCase().includes('started')) {
                        logsHTML += `
                            <div class="activity-entry mb-1 p-1 rounded">
                                <span class="text-info fw-bold">üöÄ</span>
                                <span class="text-info">${log.message}</span>
                            </div>
                        `;
                    } else {
                        logsHTML += `
                            <div class="activity-entry mb-1 p-1 rounded">
                                <span class="text-muted">${log.message || 'Activity logged'}</span>
                            </div>
                        `;
                    }
                });
                
                logsContainer.innerHTML = logsHTML;
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
        })
        .catch(error => {
            console.error(`Error updating logs for campaign ${campaignId}:`, error);
        });
}

// Manual refresh function
function refreshCampaigns() {
    updateLiveCampaigns();
    showNotification('Campaigns refreshed', 'success');
}

// Filter campaigns (original functionality)
function filterCampaigns(filterType) {
    currentFilter = filterType;
    
    // Update button states
    document.querySelectorAll('[id^="filter-"]').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('btn-outline-primary', 'btn-outline-warning', 'btn-outline-secondary');
    });
    
    const activeButton = document.getElementById(`filter-${filterType}`);
    if (activeButton) {
        activeButton.classList.add('active');
    }
    
    // Get all campaign cards
    const campaignCards = document.querySelectorAll('[data-campaign-id]');
    
    campaignCards.forEach(card => {
        const campaignId = parseInt(card.getAttribute('data-campaign-id'));
        
        // Always hide campaigns that are in the hidden set
        if (hiddenCampaigns.has(campaignId)) {
            card.style.display = 'none';
            return;
        }
        
        const statusBadge = card.querySelector('.badge');
        const status = statusBadge ? statusBadge.textContent.toLowerCase().trim() : '';
        
        let shouldShow = false;
        
        switch(filterType) {
            case 'live':
                shouldShow = status === 'running' || status === 'ready';
                break;
            case 'interrupted':
                shouldShow = status === 'paused' || status === 'stopped';
                break;
            case 'finished':
                shouldShow = status === 'completed';
                break;
            default:
                shouldShow = true;
        }
        
        card.style.display = shouldShow ? 'block' : 'none';
    });
    
    // Update statistics for visible campaigns
    updateStatistics();
}

// Update statistics based on visible campaigns
function updateStatistics() {
    const visibleCampaigns = document.querySelectorAll('[data-campaign-id]:not([style*="display: none"])');
    
    let totalCampaigns = 0;
    let totalSent = 0;
    let totalErrors = 0;
    let totalRemaining = 0;
    
    visibleCampaigns.forEach(card => {
        const campaignId = parseInt(card.getAttribute('data-campaign-id'));
        
        // Skip hidden campaigns
        if (hiddenCampaigns.has(campaignId)) {
            return;
        }
        
        totalCampaigns++;
        
        const sentElement = document.getElementById(`sent-${campaignId}`);
        const errorElement = document.getElementById(`errors-${campaignId}`);
        const remainingElement = document.getElementById(`remaining-${campaignId}`);
        
        if (sentElement) {
            totalSent += parseInt(sentElement.textContent) || 0;
        }
        
        if (errorElement) {
            totalErrors += parseInt(errorElement.textContent) || 0;
        }
        
        if (remainingElement) {
            totalRemaining += parseInt(remainingElement.textContent) || 0;
        }
    });
    
    // Update statistics display
    const totalCampaignsElement = document.getElementById('total-campaigns');
    const totalSentElement = document.getElementById('total-sent');
    const totalErrorsElement = document.getElementById('total-errors');
    const totalRemainingElement = document.getElementById('total-remaining');
    
    if (totalCampaignsElement) totalCampaignsElement.textContent = totalCampaigns;
    if (totalSentElement) totalSentElement.textContent = totalSent;
    if (totalErrorsElement) totalErrorsElement.textContent = totalErrors;
    if (totalRemainingElement) totalRemainingElement.textContent = totalRemaining;
}

function getStatusIcon(status) {
    switch (status) {
        case 'success': return '‚úÖ';
        case 'error': return '‚ùå';
        case 'info': return '‚ÑπÔ∏è';
        default: return 'üìù';
    }
}

function getStatusClass(status) {
    switch (status) {
        case 'success': return 'bg-success text-white';
        case 'error': return 'bg-danger text-white';
        case 'info': return 'bg-info text-white';
        default: return 'bg-secondary text-white';
    }
}

function stopCampaign(campaignId) {
    if (confirm('Are you sure you want to stop this campaign?')) {
        fetch(`/api/campaigns/${campaignId}/stop`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                setTimeout(() => {
                    refreshCampaigns();
                }, 1000);
            } else {
                showNotification(data.message || 'Error stopping campaign', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error stopping campaign', 'error');
        });
    }
}

function pauseCampaign(campaignId) {
    if (confirm('Are you sure you want to pause this campaign?')) {
        fetch(`/api/campaigns/${campaignId}/pause`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                showNotification(data.message, 'success');
                setTimeout(() => {
                    refreshCampaigns();
                }, 1000);
            } else {
                showNotification('Error pausing campaign', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error pausing campaign', 'error');
        });
    }
}

function resumeCampaign(campaignId) {
    if (confirm('Are you sure you want to resume this campaign?')) {
        fetch(`/api/campaigns/${campaignId}/resume`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                showNotification(data.message, 'success');
                setTimeout(() => {
                    refreshCampaigns();
                }, 1000);
            } else {
                showNotification('Error resuming campaign', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error resuming campaign', 'error');
        });
    }
}

function startCampaign(campaignId) {
    if (confirm('Are you sure you want to start this campaign?')) {
        fetch(`/api/campaigns/${campaignId}/start`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                setTimeout(() => {
                    refreshCampaigns();
                }, 1000);
            } else {
                showNotification(data.message || 'Error starting campaign', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error starting campaign', 'error');
        });
    }
}

function deleteCampaign(campaignId) {
    if (confirm('Remove this campaign from the Live Campaigns Monitor? The campaign will be hidden from this view but not deleted.')) {
        // Add to hidden campaigns set
        hiddenCampaigns.add(campaignId);
        
        // Hide the campaign card from the live view
        const campaignCard = document.querySelector(`[data-campaign-id="${campaignId}"]`);
        if (campaignCard) {
            campaignCard.style.display = 'none';
            showNotification('Campaign removed from Live Campaigns Monitor', 'success');
            
            // Update statistics after hiding
            updateStatistics();
        } else {
            showNotification('Campaign not found in view', 'error');
        }
    }
}

function clearLogs(campaignId) {
    if (confirm('Clear activity logs for this campaign? This will only clear the logs, not delete the campaign.')) {
        fetch(`/api/campaigns/${campaignId}/clear-logs`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                // Clear the logs display immediately
                const logsContainer = document.getElementById(`logs-${campaignId}`);
                if (logsContainer) {
                    logsContainer.innerHTML = `
                        <div class="text-muted text-center">
                            <i class="fas fa-info-circle"></i>
                            <br>No activity yet
                        </div>
                    `;
                }
            } else {
                showNotification(data.message || 'Error clearing logs', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error clearing logs', 'error');
        });
    }
}

function exportLogs(campaignId) {
    const logs = campaignLogs[campaignId] || [];
    const csvContent = "data:text/csv;charset=utf-8," 
        + "Timestamp,Status,Message,Email,Subject\n"
        + logs.map(log => {
            return `"${log.timestamp}","${log.status}","${log.message}","${log.email || ''}","${log.subject || ''}"`;
        }).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `campaign_${campaignId}_logs.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function showNotification(message, type = 'info') {
    const toast = document.getElementById('notification-toast');
    const toastMessage = document.getElementById('toast-message');
    
    toastMessage.textContent = message;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 5000);
}

// Add a function to restore hidden campaigns (for admin use)
function restoreHiddenCampaigns() {
    if (confirm('Restore all hidden campaigns to the Live Campaigns Monitor?')) {
        hiddenCampaigns.clear();
        
        // Show all campaign cards
        const campaignCards = document.querySelectorAll('[data-campaign-id]');
        campaignCards.forEach(card => {
            card.style.display = 'block';
        });
        
        // Re-apply current filter
        filterCampaigns(currentFilter);
        
        showNotification('All hidden campaigns restored', 'success');
    }
}

// Add a function to show hidden campaigns count
function showHiddenCampaignsCount() {
    if (hiddenCampaigns.size > 0) {
        showNotification(`${hiddenCampaigns.size} campaign(s) hidden from view`, 'info');
    } else {
        showNotification('No campaigns are hidden', 'info');
    }
}

// Event listeners for controls
document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh toggle
    const autoRefreshToggle = document.getElementById('autoRefreshToggle');
    if (autoRefreshToggle) {
        autoRefreshToggle.addEventListener('change', function() {
            if (this.checked) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });
    }
    
    // Refresh interval change
    const refreshInterval = document.getElementById('refreshInterval');
    if (refreshInterval) {
        refreshInterval.addEventListener('change', function() {
            stopAutoRefresh();
            if (autoRefreshToggle && autoRefreshToggle.checked) {
                startAutoRefresh();
            }
        });
    }
    
    // Grid selector
    const gridSelector = document.getElementById('gridSelector');
    if (gridSelector) {
        gridSelector.addEventListener('change', function() {
            const campaignsContainer = document.getElementById('campaigns-container');
            if (campaignsContainer) {
                campaignsContainer.className = `row`;
                const cols = parseInt(this.value);
                const colClass = cols === 1 ? 'col-12' : 
                               cols === 2 ? 'col-lg-6' : 
                               cols === 3 ? 'col-lg-4' : 
                               cols === 4 ? 'col-lg-3' : 'col-lg-2';
                
                const campaignCards = campaignsContainer.querySelectorAll('[data-campaign-id]');
                campaignCards.forEach(card => {
                    card.className = `${colClass} mb-4`;
                });
            }
        });
    }
    
    // Initialize
    updateStatistics();
    startAutoRefresh();
    
    // Initial refresh to get latest data
    setTimeout(() => {
        refreshCampaigns();
    }, 1000);
});

// Load account names
{% for campaign in campaigns %}
fetch(`/api/accounts/{{ campaign.account_id }}`)
    .then(response => response.json())
    .then(account => {
        const element = document.getElementById('account-name-{{ campaign.id }}');
        if (element) element.textContent = account.name;
    })
    .catch(error => {
        const element = document.getElementById('account-name-{{ campaign.id }}');
        if (element) element.textContent = 'Unknown';
    });
{% endfor %}
</script>
{% endblock %} 