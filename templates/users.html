{% extends "base.html" %}

{% block title %}User Management - Email Campaign Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">User Management</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="fas fa-user-plus me-2"></i>Add User
        </button>
    </div>
</div>

<div class="row" id="usersList">
    <!-- Users will be loaded here -->
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username *</label>
                                <input type="text" class="form-control" id="username" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="password" class="form-label">Password *</label>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="role" class="form-label">Role</label>
                                <select class="form-select" id="role">
                                    <option value="user">User</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Permissions</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="perm_add_account" value="add_account">
                                    <label class="form-check-label" for="perm_add_account">
                                        Add Zoho Accounts
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="perm_manage_accounts" value="manage_accounts">
                                    <label class="form-check-label" for="perm_manage_accounts">
                                        Manage All Accounts
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="perm_manage_data" value="manage_data">
                                    <label class="form-check-label" for="perm_manage_data">
                                        Manage Data Lists
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="perm_view_all_campaigns" value="view_all_campaigns">
                                    <label class="form-check-label" for="perm_view_all_campaigns">
                                        View All Campaigns
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="perm_manage_all_campaigns" value="manage_all_campaigns">
                                    <label class="form-check-label" for="perm_manage_all_campaigns">
                                        Manage All Campaigns
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="perm_view_reports" value="view_reports">
                                    <label class="form-check-label" for="perm_view_reports">
                                        View Reports
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_active" checked>
                            <label class="form-check-label" for="is_active">
                                Active Account
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">Save User</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="edit_user_id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_username" class="form-label">Username *</label>
                                <input type="text" class="form-control" id="edit_username" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_email" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="edit_email" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_password" class="form-label">New Password (leave blank to keep current)</label>
                                <input type="password" class="form-control" id="edit_password">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_role" class="form-label">Role</label>
                                <select class="form-select" id="edit_role">
                                    <option value="user">User</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Permissions</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit_perm_add_account" value="add_account">
                                    <label class="form-check-label" for="edit_perm_add_account">
                                        Add Zoho Accounts
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit_perm_manage_accounts" value="manage_accounts">
                                    <label class="form-check-label" for="edit_perm_manage_accounts">
                                        Manage All Accounts
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit_perm_manage_data" value="manage_data">
                                    <label class="form-check-label" for="edit_perm_manage_data">
                                        Manage Data Lists
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit_perm_view_all_campaigns" value="view_all_campaigns">
                                    <label class="form-check-label" for="edit_perm_view_all_campaigns">
                                        View All Campaigns
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit_perm_manage_all_campaigns" value="manage_all_campaigns">
                                    <label class="form-check-label" for="edit_perm_manage_all_campaigns">
                                        Manage All Campaigns
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit_perm_view_reports" value="view_reports">
                                    <label class="form-check-label" for="edit_perm_view_reports">
                                        View Reports
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit_is_active">
                            <label class="form-check-label" for="edit_is_active">
                                Active Account
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateUser()">Update User</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load users on page load
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
});

function loadUsers() {
    fetch('/api/users')
        .then(response => response.json())
        .then(users => {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            
            users.forEach(user => {
                const userCard = createUserCard(user);
                usersList.appendChild(userCard);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading users');
        });
}

function createUserCard(user) {
    const div = document.createElement('div');
    div.className = 'col-md-6 col-lg-4 mb-4';
    
    const permissions = user.permissions || [];
    const permissionsList = permissions.map(perm => {
        const permNames = {
            'add_account': 'Add Accounts',
            'manage_accounts': 'Manage All Accounts',
            'manage_data': 'Manage Data',
            'view_all_campaigns': 'View All Campaigns',
            'manage_all_campaigns': 'Manage All Campaigns',
            'manage_users': 'Manage Users',
            'view_reports': 'View Reports'
        };
        return permNames[perm] || perm;
    }).join(', ');
    
    div.innerHTML = `
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">${user.username}</h6>
                <div>
                    ${user.role === 'admin' ? '<span class="badge bg-danger">Admin</span>' : '<span class="badge bg-secondary">User</span>'}
                    ${user.is_active ? '<span class="badge bg-success ms-1">Active</span>' : '<span class="badge bg-danger ms-1">Inactive</span>'}
                </div>
            </div>
            <div class="card-body">
                <p class="card-text"><strong>Email:</strong> ${user.email}</p>
                <p class="card-text"><strong>Created:</strong> ${user.created_at ? user.created_at.substring(0, 10) : 'Unknown'}</p>
                ${permissions.length > 0 ? `<p class="card-text"><strong>Permissions:</strong> ${permissionsList}</p>` : ''}
            </div>
            <div class="card-footer">
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="editUser(${user.id})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteUser(${user.id}, '${user.username}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    `;
    
    return div;
}

function saveUser() {
    const username = document.getElementById('username').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const role = document.getElementById('role').value;
    const isActive = document.getElementById('is_active').checked;
    
    // Get selected permissions
    const permissions = [];
    const permissionCheckboxes = [
        'perm_add_account', 'perm_manage_accounts', 'perm_manage_data',
        'perm_view_all_campaigns', 'perm_manage_all_campaigns', 'perm_view_reports'
    ];
    
    permissionCheckboxes.forEach(permId => {
        if (document.getElementById(permId).checked) {
            permissions.push(document.getElementById(permId).value);
        }
    });
    
    if (!username || !email || !password) {
        alert('Please fill in all required fields');
        return;
    }
    
    const formData = {
        username: username,
        email: email,
        password: password,
        role: role,
        is_active: isActive,
        permissions: permissions
    };
    
    fetch('/api/users', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            alert('User created successfully!');
            document.getElementById('addUserForm').reset();
            // Hide the modal using Bootstrap 5 method
            const addModal = document.getElementById('addUserModal');
            if (addModal) {
                const modal = bootstrap.Modal.getInstance(addModal);
                if (modal) {
                    modal.hide();
                } else {
                    const newModal = new bootstrap.Modal(addModal);
                    newModal.hide();
                }
            }
            loadUsers();
        } else {
            alert('Error creating user: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating user');
    });
}

function editUser(userId) {
    console.log('Loading user data for ID:', userId);
    fetch(`/api/users/${userId}`)
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(user => {
            console.log('User data received:', user);
            if (!user) {
                throw new Error('No user data received');
            }
            
            document.getElementById('edit_user_id').value = user.id;
            document.getElementById('edit_username').value = user.username;
            document.getElementById('edit_email').value = user.email;
            document.getElementById('edit_role').value = user.role;
            document.getElementById('edit_is_active').checked = user.is_active;
            document.getElementById('edit_password').value = '';
            
            // Reset all permission checkboxes
            const permissionCheckboxes = [
                'edit_perm_add_account', 'edit_perm_manage_accounts', 'edit_perm_manage_data',
                'edit_perm_view_all_campaigns', 'edit_perm_manage_all_campaigns', 'edit_perm_view_reports'
            ];
            
            permissionCheckboxes.forEach(permId => {
                document.getElementById(permId).checked = false;
            });
            
            // Check the user's permissions
            const permissions = user.permissions || [];
            console.log('User permissions:', permissions);
            permissions.forEach(perm => {
                const checkboxId = `edit_perm_${perm}`;
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) {
                    checkbox.checked = true;
                } else {
                    console.warn('Permission checkbox not found:', checkboxId);
                }
            });
            
            // Show the modal using Bootstrap 5 method
            const editModal = document.getElementById('editUserModal');
            if (editModal) {
                const modal = new bootstrap.Modal(editModal);
                modal.show();
            } else {
                console.error('Edit modal not found');
                alert('Error: Edit modal not found');
            }
        })
        .catch(error => {
            console.error('Error loading user data:', error);
            alert('Error loading user data: ' + error.message);
        });
}

function updateUser() {
    const userId = document.getElementById('edit_user_id').value;
    const username = document.getElementById('edit_username').value.trim();
    const email = document.getElementById('edit_email').value.trim();
    const password = document.getElementById('edit_password').value;
    const role = document.getElementById('edit_role').value;
    const isActive = document.getElementById('edit_is_active').checked;
    
    // Get selected permissions
    const permissions = [];
    const permissionCheckboxes = [
        'edit_perm_add_account', 'edit_perm_manage_accounts', 'edit_perm_manage_data',
        'edit_perm_view_all_campaigns', 'edit_perm_manage_all_campaigns', 'edit_perm_view_reports'
    ];
    
    permissionCheckboxes.forEach(permId => {
        if (document.getElementById(permId).checked) {
            permissions.push(document.getElementById(permId).value);
        }
    });
    
    if (!username || !email) {
        alert('Please fill in all required fields');
        return;
    }
    
    const formData = {
        username: username,
        email: email,
        role: role,
        is_active: isActive,
        permissions: permissions
    };
    
    if (password) {
        formData.password = password;
    }
    
    fetch(`/api/users/${userId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            alert('User updated successfully!');
            // Hide the modal using Bootstrap 5 method
            const editModal = document.getElementById('editUserModal');
            if (editModal) {
                const modal = bootstrap.Modal.getInstance(editModal);
                if (modal) {
                    modal.hide();
                } else {
                    const newModal = new bootstrap.Modal(editModal);
                    newModal.hide();
                }
            }
            loadUsers();
        } else {
            alert('Error updating user: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating user');
    });
}

function deleteUser(userId, username) {
    if (confirm(`Are you sure you want to delete user "${username}"?`)) {
        fetch(`/api/users/${userId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                alert('User deleted successfully!');
                loadUsers();
            } else {
                response.json().then(data => {
                    alert('Error deleting user: ' + (data.error || 'Unknown error'));
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting user');
        });
    }
}
</script>
{% endblock %} 