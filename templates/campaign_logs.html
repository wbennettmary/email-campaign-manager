{% extends "base.html" %}

{% block title %}{{ campaign.name }} - Logs{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-bullhorn text-primary"></i>
            {{ campaign.name }} - Logs
        </h1>
        <a href="/campaigns" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Campaigns
        </a>
    </div>

    <div class="row">
        <!-- Campaign Information -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i> Campaign Information
                    </h5>
                </div>
                <div class="card-body">
                    <p><strong>Status:</strong> 
                        <span class="badge {{ get_status_badge_class(campaign.status) }}">
                            {{ campaign.status|title }}
                        </span>
                    </p>
                    {% if campaign.system_version == 'universal_v2' %}
                        <p><strong>System:</strong> <span class="badge bg-primary">Universal v2</span></p>
                        <p><strong>Data List ID:</strong> {{ campaign.data_list_id }}</p>
                        <p><strong>Subject:</strong> {{ campaign.subject[:50] }}{% if campaign.subject|length > 50 %}...{% endif %}</p>
                        <p><strong>From Name:</strong> {{ campaign.from_name or 'Default' }}</p>
                        <p><strong>Template Type:</strong> {% if campaign.use_custom_template %}Custom{% else %}Zoho{% endif %}</p>
                        <p><strong>Total Recipients:</strong> <span id="total-recipients">Loading...</span></p>
                    {% else %}
                        <p><strong>System:</strong> <span class="badge bg-secondary">Legacy</span></p>
                        <p><strong>Total Recipients:</strong> {{ campaign.destinataires.split('\n')|length }}</p>
                    {% endif %}
                    <p><strong>Emails Sent:</strong> {{ campaign.total_sent or 0 }}</p>
                    <p><strong>Template ID:</strong> {{ campaign.template_id }}</p>
                    <p><strong>Created:</strong> {{ campaign.created_at }}</p>
                    {% if campaign.started_at %}
                    <p><strong>Started:</strong> {{ campaign.started_at }}</p>
                    {% endif %}
                    {% if campaign.completed_at %}
                    <p><strong>Completed:</strong> {{ campaign.completed_at }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Progress -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line"></i> Progress
                    </h5>
                </div>
                <div class="card-body">
                    <div class="progress mb-3" style="height: 25px;">
                        {% if campaign.system_version == 'universal_v2' %}
                            {% set total = campaign.total_attempted or 0 %}
                            {% set sent = campaign.total_sent or 0 %}
                        {% else %}
                            {% set total = campaign.destinataires.split('\n')|length %}
                            {% set sent = campaign.total_sent or 0 %}
                        {% endif %}
                        {% set progress = (sent / total * 100) if total > 0 else 0 %}
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress }}%">
                            {{ sent }}/{{ total }}
                        </div>
                    </div>
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 class="text-success mb-0" id="sent-count">{{ sent }}</h4>
                            <small class="text-muted">Sent</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-danger mb-0" id="error-count">0</h4>
                            <small class="text-muted">Errors</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-info mb-0" id="remaining-count">{{ total - sent }}</h4>
                            <small class="text-muted">Remaining</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Email Logs -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-arrow-right"></i> Live Email Logs
            </h5>
            <div class="btn-group">
                <button class="btn btn-outline-success btn-sm" onclick="refreshLogs()" id="refresh-btn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="clearLogs()">
                    <i class="fas fa-trash"></i> Clear Logs
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="exportLogs()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="border rounded p-3" style="height: 500px; overflow-y: auto; background-color: #f8f9fa;" id="logs-container">
                {% if logs %}
                    {% for log in logs %}
                    <div class="log-entry {{ get_status_badge_class(log.status) }} mb-2 p-2 rounded">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <span class="badge {{ get_status_badge_class(log.status) }} me-2">
                                    {% if log.status == 'success' %}‚úÖ{% elif log.status == 'error' %}‚ùå{% else %}‚ÑπÔ∏è{% endif %}
                                </span>
                                <span class="fw-bold">{{ format_timestamp(log.timestamp) }}</span>
                                <span class="ms-2">{{ log.message }}</span>
                                {% if log.email %}
                                <br><small class="text-muted">To: {{ log.email }}</small>
                                {% endif %}
                                {% if log.subject %}
                                <br><small class="text-muted">Subject: {{ log.subject }}</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-muted text-center">
                        <i class="fas fa-hourglass-half fa-2x mb-2"></i>
                        <br>Waiting for campaign activity...
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
const socket = io();
const campaignId = {{ campaign.id }};
const isUniversalCampaign = {{ 'true' if campaign.system_version == 'universal_v2' else 'false' }};
let logs = [];
let sentCount = {{ campaign.total_sent or 0 }};
let errorCount = 0;
let totalEmails = 0;

// Initialize total emails based on campaign type
{% if campaign.system_version == 'universal_v2' %}
    // For universal campaigns, we'll load the count from the data list
    totalEmails = {{ campaign.total_attempted or 0 }};
    // Load actual count from data list if available
    if ({{ campaign.data_list_id }}) {
        fetch(`/api/data-lists/{{ campaign.data_list_id }}/campaign-emails`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    totalEmails = data.email_count;
                    document.getElementById('total-recipients').textContent = totalEmails;
                    document.getElementById('remaining-count').textContent = totalEmails - sentCount;
                }
            })
            .catch(error => {
                console.error('Error loading data list count:', error);
                document.getElementById('total-recipients').textContent = totalEmails;
            });
    }
{% else %}
    // For legacy campaigns, use the destinataires count
    totalEmails = {{ campaign.destinataires.split('\n')|length }};
{% endif %}

// Load existing logs from the page
{% if logs %}
    {% for log in logs %}
    logs.push({
        timestamp: '{{ log.timestamp }}',
        status: '{{ log.status }}',
        message: '{{ log.message }}',
        email: '{{ log.email or "" }}',
        subject: '{{ log.subject or "" }}',
        sender: '{{ log.sender or "" }}'
    });
    {% endfor %}
{% endif %}

// Listen for email progress updates
socket.on('email_progress', function(data) {
    if (data.campaign_id === campaignId) {
        addLog(data);
        updateProgress(data);
    }
});

// Listen for campaign completion
socket.on('campaign_completed', function(data) {
    if (data.campaign_id === campaignId) {
        addLog({
            timestamp: new Date().toISOString(),
            status: 'info',
            message: `üèÅ Campaign completed! Total sent: ${data.total_sent}/${data.total_attempted}`,
            type: 'completion'
        });
        
        // Stop auto-refresh when campaign is completed
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }
});

// Auto-refresh functionality
let autoRefreshInterval = null;

function startAutoRefresh() {
    // Only start auto-refresh if campaign is running
    if ({{ 'true' if campaign.status == 'running' else 'false' }}) {
        autoRefreshInterval = setInterval(() => {
            refreshLogs();
        }, 10000); // Refresh every 10 seconds
    }
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// Start auto-refresh when page loads
document.addEventListener('DOMContentLoaded', function() {
    startAutoRefresh();
});

// Stop auto-refresh when page is hidden
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopAutoRefresh();
    } else {
        startAutoRefresh();
    }
});

function addLog(data) {
    const logsContainer = document.getElementById('logs-container');
    const logEntry = document.createElement('div');
    
    const timestamp = new Date(data.timestamp).toLocaleString();
    const statusIcon = getStatusIcon(data.status);
    const statusClass = getStatusClass(data.status);
    
    logEntry.className = `log-entry ${statusClass} mb-2 p-2 rounded`;
    logEntry.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
                <span class="badge ${statusClass} me-2">${statusIcon}</span>
                <span class="fw-bold">${timestamp}</span>
                <span class="ms-2">${data.message}</span>
                ${data.email ? `<br><small class="text-muted">To: ${data.email}</small>` : ''}
                ${data.subject ? `<br><small class="text-muted">Subject: ${data.subject}</small>` : ''}
            </div>
        </div>
    `;
    
    // Clear "waiting" message if it exists
    if (logsContainer.querySelector('.text-muted.text-center')) {
        logsContainer.innerHTML = '';
    }
    
    logsContainer.appendChild(logEntry);
    logsContainer.scrollTop = logsContainer.scrollHeight;
    
    // Store in memory
    logs.push(data);
}

function updateProgress(data) {
    if (data.status === 'success') {
        sentCount++;
        document.getElementById('sent-count').textContent = sentCount;
    } else if (data.status === 'error') {
        errorCount++;
        document.getElementById('error-count').textContent = errorCount;
    }
    
    const remaining = totalEmails - sentCount - errorCount;
    document.getElementById('remaining-count').textContent = remaining;
    
    // Update progress bar
    const progress = Math.round((sentCount + errorCount) / totalEmails * 100);
    const progressBar = document.querySelector('.progress-bar');
    if (progressBar) {
        progressBar.style.width = progress + '%';
        progressBar.textContent = `${sentCount + errorCount}/${totalEmails}`;
    }
}

function getStatusIcon(status) {
    switch (status) {
        case 'success': return '‚úÖ';
        case 'error': return '‚ùå';
        case 'info': return '‚ÑπÔ∏è';
        default: return 'üìù';
    }
}

function getStatusClass(status) {
    switch (status) {
        case 'success': return 'bg-success text-white';
        case 'error': return 'bg-danger text-white';
        case 'info': return 'bg-info text-white';
        default: return 'bg-secondary text-white';
    }
}

function clearLogs() {
    if (confirm('Clear all logs? This action cannot be undone.')) {
        document.getElementById('logs-container').innerHTML = `
            <div class="text-muted text-center">
                <i class="fas fa-hourglass-half fa-2x mb-2"></i>
                <br>Waiting for campaign activity...
            </div>
        `;
        logs = [];
    }
}

function refreshLogs() {
    const refreshBtn = document.getElementById('refresh-btn');
    const originalText = refreshBtn.innerHTML;
    
    // Show loading state
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    refreshBtn.disabled = true;
    
    // Fetch latest logs and campaign data
    fetch(`/api/campaigns/${campaignId}/logs/refresh`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update logs display
                updateLogsDisplay(data.logs);
                
                // Update campaign stats if available
                if (data.campaign) {
                    updateCampaignStats(data.campaign);
                }
                
                // Show success message
                showNotification('Logs refreshed successfully!', 'success');
            } else {
                showNotification('Failed to refresh logs: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Error refreshing logs:', error);
            showNotification('Error refreshing logs: ' + error.message, 'error');
        })
        .finally(() => {
            // Restore button state
            refreshBtn.innerHTML = originalText;
            refreshBtn.disabled = false;
        });
}

function updateLogsDisplay(newLogs) {
    const logsContainer = document.getElementById('logs-container');
    
    // Clear existing logs
    logsContainer.innerHTML = '';
    
    if (newLogs && newLogs.length > 0) {
        // Add new logs
        newLogs.forEach(log => {
            const logEntry = document.createElement('div');
            const timestamp = new Date(log.timestamp).toLocaleString();
            const statusIcon = getStatusIcon(log.status);
            const statusClass = getStatusClass(log.status);
            
            logEntry.className = `log-entry ${statusClass} mb-2 p-2 rounded`;
            logEntry.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <span class="badge ${statusClass} me-2">${statusIcon}</span>
                        <span class="fw-bold">${timestamp}</span>
                        <span class="ms-2">${log.message}</span>
                        ${log.email ? `<br><small class="text-muted">To: ${log.email}</small>` : ''}
                        ${log.subject ? `<br><small class="text-muted">Subject: ${log.subject}</small>` : ''}
                    </div>
                </div>
            `;
            
            logsContainer.appendChild(logEntry);
        });
        
        // Update logs array
        logs = newLogs;
    } else {
        // Show empty state
        logsContainer.innerHTML = `
            <div class="text-muted text-center">
                <i class="fas fa-hourglass-half fa-2x mb-2"></i>
                <br>No logs found...
            </div>
        `;
        logs = [];
    }
    
    // Scroll to bottom
    logsContainer.scrollTop = logsContainer.scrollHeight;
}

function updateCampaignStats(campaign) {
    // Update progress bar and counts
    const total = campaign.total_attempted || 0;
    const sent = campaign.total_sent || 0;
    const progress = total > 0 ? Math.round((sent / total) * 100) : 0;
    
    // Update progress bar
    const progressBar = document.querySelector('.progress-bar');
    if (progressBar) {
        progressBar.style.width = progress + '%';
        progressBar.textContent = `${sent}/${total}`;
    }
    
    // Update counts
    document.getElementById('sent-count').textContent = sent;
    document.getElementById('remaining-count').textContent = total - sent;
    
    // Update total recipients if available
    if (campaign.data_list_id) {
        document.getElementById('total-recipients').textContent = total;
    }
}

function showNotification(message, type = 'info') {
    // Create a simple notification
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

function exportLogs() {
    const csvContent = "data:text/csv;charset=utf-8," 
        + "Timestamp,Status,Message,Email,Subject\n"
        + logs.map(log => {
            return `"${log.timestamp}","${log.status}","${log.message}","${log.email || ''}","${log.subject || ''}"`;
        }).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `campaign_${campaignId}_logs.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endblock %} 