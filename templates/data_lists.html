{% extends "base.html" %}

{% block title %}Data Lists Management{% endblock %}

{% block page_title %}Data Lists Management{% endblock %}

{% block content %}
<div class="row">
    <!-- Statistics Cards -->
    <div class="col-12 mb-4">
        <div class="row">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0" id="total-lists">0</h4>
                                <p class="mb-0">Total Lists</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-list fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0" id="total-emails">0</h4>
                                <p class="mb-0">Total Emails</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-envelope fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0" id="total-geographies">0</h4>
                                <p class="mb-0">Geographies</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-globe fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0" id="total-isps">0</h4>
                                <p class="mb-0">ISPs</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-server fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-plus-circle me-2"></i>Add New Data List
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                            <i class="fas fa-upload me-2"></i>Upload File
                        </button>
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#manualModal">
                            <i class="fas fa-edit me-2"></i>Manual Entry
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="geographyFilter" class="form-label">Geography</label>
                        <select class="form-select" id="geographyFilter">
                            <option value="">All Geographies</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="ispFilter" class="form-label">ISP</label>
                        <select class="form-select" id="ispFilter">
                            <option value="">All ISPs</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="searchFilter" class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchFilter" placeholder="Search lists...">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times me-2"></i>Clear Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Lists Table -->
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="dataListsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Geography</th>
                                <th>ISP</th>
                                <th>Email Count</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dataListsTableBody">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div id="noDataMessage" class="text-center py-4" style="display: none;">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No data lists found</h5>
                    <p class="text-muted">Create your first data list by uploading a file or adding emails manually.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload File Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-upload me-2"></i>Upload Data List
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="uploadName" class="form-label">List Name *</label>
                        <input type="text" class="form-control" id="uploadName" name="name" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="uploadGeography" class="form-label">Geography</label>
                                                         <select class="form-select" id="uploadGeography" name="geography">
                                 <option value="">Select Geography</option>
                                 <optgroup label="Europe">
                                     <option value="DE">Germany (DE)</option>
                                     <option value="NL">Netherlands (NL)</option>
                                     <option value="FR">France (FR)</option>
                                     <option value="FI">Finland (FI)</option>
                                     <option value="DK">Denmark (DK)</option>
                                     <option value="NO">Norway (NO)</option>
                                     <option value="ES">Spain (ES)</option>
                                     <option value="BE">Belgium (BE)</option>
                                     <option value="UK">United Kingdom (UK)</option>
                                     <option value="Europe">Europe (General)</option>
                                 </optgroup>
                                 <optgroup label="Other Regions">
                                     <option value="North America">North America</option>
                                     <option value="Asia">Asia</option>
                                     <option value="Africa">Africa</option>
                                     <option value="South America">South America</option>
                                     <option value="Australia">Australia</option>
                                     <option value="Global">Global</option>
                                 </optgroup>
                             </select>
                        </div>
                        <div class="col-md-6">
                            <label for="uploadIsp" class="form-label">ISP</label>
                            <select class="form-select" id="uploadIsp" name="isp">
                                <option value="">Select ISP</option>
                                <option value="Gmail">Gmail</option>
                                <option value="Yahoo">Yahoo</option>
                                <option value="Outlook">Outlook</option>
                                <option value="Hotmail">Hotmail</option>
                                <option value="AOL">AOL</option>
                                <option value="ProtonMail">ProtonMail</option>
                                <option value="Custom">Custom</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="uploadDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="uploadDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="uploadFile" class="form-label">File *</label>
                        <input type="file" class="form-control" id="uploadFile" name="file" accept=".csv,.txt" required>
                        <div class="form-text">Supported formats: CSV, TXT. One email per line.</div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>File Format:</strong> Upload a CSV or TXT file with one email address per line. 
                        For CSV files, the system will automatically detect the email column.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadDataList()">
                    <i class="fas fa-upload me-2"></i>Upload
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Manual Entry Modal -->
<div class="modal fade" id="manualModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Manual Data List Entry
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="manualForm">
                    <div class="mb-3">
                        <label for="manualName" class="form-label">List Name *</label>
                        <input type="text" class="form-control" id="manualName" name="name" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="manualGeography" class="form-label">Geography</label>
                                                         <select class="form-select" id="manualGeography" name="geography">
                                 <option value="">Select Geography</option>
                                 <optgroup label="Europe">
                                     <option value="DE">Germany (DE)</option>
                                     <option value="NL">Netherlands (NL)</option>
                                     <option value="FR">France (FR)</option>
                                     <option value="FI">Finland (FI)</option>
                                     <option value="DK">Denmark (DK)</option>
                                     <option value="NO">Norway (NO)</option>
                                     <option value="ES">Spain (ES)</option>
                                     <option value="BE">Belgium (BE)</option>
                                     <option value="UK">United Kingdom (UK)</option>
                                     <option value="Europe">Europe (General)</option>
                                 </optgroup>
                                 <optgroup label="Other Regions">
                                     <option value="North America">North America</option>
                                     <option value="Asia">Asia</option>
                                     <option value="Africa">Africa</option>
                                     <option value="South America">South America</option>
                                     <option value="Australia">Australia</option>
                                     <option value="Global">Global</option>
                                 </optgroup>
                             </select>
                        </div>
                        <div class="col-md-6">
                            <label for="manualIsp" class="form-label">ISP</label>
                            <select class="form-select" id="manualIsp" name="isp">
                                <option value="">Select ISP</option>
                                <option value="Gmail">Gmail</option>
                                <option value="Yahoo">Yahoo</option>
                                <option value="Outlook">Outlook</option>
                                <option value="Hotmail">Hotmail</option>
                                <option value="AOL">AOL</option>
                                <option value="ProtonMail">ProtonMail</option>
                                <option value="Custom">Custom</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="manualDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="manualDescription" name="description" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="manualEmails" class="form-label">Email Addresses *</label>
                        <textarea class="form-control" id="manualEmails" name="emails" rows="10" placeholder="Enter email addresses, one per line..." required></textarea>
                        <div class="form-text">
                            <span id="emailCount">0</span> valid emails detected
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createManualDataList()">
                    <i class="fas fa-save me-2"></i>Create List
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View List Modal -->
<div class="modal fade" id="viewListModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>View Data List
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Name:</strong> <span id="viewListName"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Email Count:</strong> <span id="viewListCount"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Geography:</strong> <span id="viewListGeography"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>ISP:</strong> <span id="viewListIsp"></span>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>Description:</strong> <span id="viewListDescription"></span>
                </div>
                <div class="mb-3">
                    <label class="form-label">Emails:</label>
                    <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                        <div id="viewListEmails"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="downloadDataList()">
                    <i class="fas fa-download me-2"></i>Download CSV
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit List Modal -->
<div class="modal fade" id="editListModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Edit Data List
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editListId">
                    <div class="mb-3">
                        <label for="editName" class="form-label">List Name *</label>
                        <input type="text" class="form-control" id="editName" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="editGeography" class="form-label">Geography</label>
                                                         <select class="form-select" id="editGeography">
                                 <option value="">Select Geography</option>
                                 <optgroup label="Europe">
                                     <option value="DE">Germany (DE)</option>
                                     <option value="NL">Netherlands (NL)</option>
                                     <option value="FR">France (FR)</option>
                                     <option value="FI">Finland (FI)</option>
                                     <option value="DK">Denmark (DK)</option>
                                     <option value="NO">Norway (NO)</option>
                                     <option value="ES">Spain (ES)</option>
                                     <option value="BE">Belgium (BE)</option>
                                     <option value="UK">United Kingdom (UK)</option>
                                     <option value="Europe">Europe (General)</option>
                                 </optgroup>
                                 <optgroup label="Other Regions">
                                     <option value="North America">North America</option>
                                     <option value="Asia">Asia</option>
                                     <option value="Africa">Africa</option>
                                     <option value="South America">South America</option>
                                     <option value="Australia">Australia</option>
                                     <option value="Global">Global</option>
                                 </optgroup>
                             </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editIsp" class="form-label">ISP</label>
                            <select class="form-select" id="editIsp">
                                <option value="">Select ISP</option>
                                <option value="Gmail">Gmail</option>
                                <option value="Yahoo">Yahoo</option>
                                <option value="Outlook">Outlook</option>
                                <option value="Hotmail">Hotmail</option>
                                <option value="AOL">AOL</option>
                                <option value="ProtonMail">ProtonMail</option>
                                <option value="Custom">Custom</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateDataList()">
                    <i class="fas fa-save me-2"></i>Update
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentDataLists = [];
let currentViewListId = null;

// Load data lists on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDataLists();
    
    // Add event listeners
    document.getElementById('manualEmails').addEventListener('input', updateEmailCount);
    document.getElementById('geographyFilter').addEventListener('change', filterDataLists);
    document.getElementById('ispFilter').addEventListener('change', filterDataLists);
    document.getElementById('searchFilter').addEventListener('input', filterDataLists);
});

function loadDataLists() {
    fetch('/api/data-lists')
        .then(response => response.json())
        .then(data => {
            currentDataLists = data;
            displayDataLists(data);
            updateStatistics(data);
            updateFilters(data);
        })
        .catch(error => {
            console.error('Error loading data lists:', error);
            showNotification('Error loading data lists', 'error');
        });
}

function displayDataLists(dataLists) {
    const tbody = document.getElementById('dataListsTableBody');
    const noDataMessage = document.getElementById('noDataMessage');
    
    if (dataLists.length === 0) {
        tbody.innerHTML = '';
        noDataMessage.style.display = 'block';
        return;
    }
    
    noDataMessage.style.display = 'none';
    tbody.innerHTML = '';
    
    dataLists.forEach(list => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${list.id}</td>
            <td>
                <strong>${list.name}</strong>
                ${list.description ? `<br><small class="text-muted">${list.description}</small>` : ''}
            </td>
            <td><span class="badge bg-info">${list.geography || 'Unknown'}</span></td>
            <td><span class="badge bg-warning">${list.isp || 'Unknown'}</span></td>
            <td><span class="badge bg-success">${list.email_count}</span></td>
            <td>${formatDate(list.created_at)}</td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary" onclick="viewDataList(${list.id})" title="View">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-info" onclick="editDataList(${list.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-success" onclick="downloadDataList(${list.id})" title="Download">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteDataList(${list.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function updateStatistics(dataLists) {
    const totalLists = dataLists.length;
    const totalEmails = dataLists.reduce((sum, list) => sum + list.email_count, 0);
    const geographies = new Set(dataLists.map(list => list.geography).filter(g => g));
    const isps = new Set(dataLists.map(list => list.isp).filter(i => i));
    
    document.getElementById('total-lists').textContent = totalLists;
    document.getElementById('total-emails').textContent = totalEmails.toLocaleString();
    document.getElementById('total-geographies').textContent = geographies.size;
    document.getElementById('total-isps').textContent = isps.size;
}

function updateFilters(dataLists) {
    const geographyFilter = document.getElementById('geographyFilter');
    const ispFilter = document.getElementById('ispFilter');
    
    // Clear existing options
    geographyFilter.innerHTML = '<option value="">All Geographies</option>';
    ispFilter.innerHTML = '<option value="">All ISPs</option>';
    
    // Add unique values
    const geographies = [...new Set(dataLists.map(list => list.geography).filter(g => g))];
    const isps = [...new Set(dataLists.map(list => list.isp).filter(i => i))];
    
    geographies.forEach(geo => {
        const option = document.createElement('option');
        option.value = geo;
        option.textContent = geo;
        geographyFilter.appendChild(option);
    });
    
    isps.forEach(isp => {
        const option = document.createElement('option');
        option.value = isp;
        option.textContent = isp;
        ispFilter.appendChild(option);
    });
}

function filterDataLists() {
    const geographyFilter = document.getElementById('geographyFilter').value;
    const ispFilter = document.getElementById('ispFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    
    const filtered = currentDataLists.filter(list => {
        const matchesGeography = !geographyFilter || list.geography === geographyFilter;
        const matchesIsp = !ispFilter || list.isp === ispFilter;
        const matchesSearch = !searchFilter || 
            list.name.toLowerCase().includes(searchFilter) ||
            (list.description && list.description.toLowerCase().includes(searchFilter));
        
        return matchesGeography && matchesIsp && matchesSearch;
    });
    
    displayDataLists(filtered);
}

function clearFilters() {
    document.getElementById('geographyFilter').value = '';
    document.getElementById('ispFilter').value = '';
    document.getElementById('searchFilter').value = '';
    filterDataLists();
}

function updateEmailCount() {
    const emailsText = document.getElementById('manualEmails').value;
    const emails = emailsText.split('\n').filter(email => email.trim() && isValidEmail(email.trim()));
    document.getElementById('emailCount').textContent = emails.length;
}

function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function uploadDataList() {
    const form = document.getElementById('uploadForm');
    const formData = new FormData(form);
    
    fetch('/api/data-lists', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        showNotification('Data list uploaded successfully!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
        form.reset();
        loadDataLists();
    })
    .catch(error => {
        console.error('Error uploading data list:', error);
        showNotification(error.message, 'error');
    });
}

function createManualDataList() {
    const form = document.getElementById('manualForm');
    const formData = new FormData(form);
    
    const data = {
        name: formData.get('name'),
        geography: formData.get('geography'),
        isp: formData.get('isp'),
        description: formData.get('description'),
        emails: formData.get('emails')
    };
    
    fetch('/api/data-lists', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        showNotification('Data list created successfully!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('manualModal')).hide();
        form.reset();
        document.getElementById('emailCount').textContent = '0';
        loadDataLists();
    })
    .catch(error => {
        console.error('Error creating data list:', error);
        showNotification(error.message, 'error');
    });
}

function viewDataList(listId) {
    currentViewListId = listId;
    
    fetch(`/api/data-lists/${listId}?include_emails=true`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            document.getElementById('viewListName').textContent = data.name;
            document.getElementById('viewListCount').textContent = data.email_count;
            document.getElementById('viewListGeography').textContent = data.geography || 'Unknown';
            document.getElementById('viewListIsp').textContent = data.isp || 'Unknown';
            document.getElementById('viewListDescription').textContent = data.description || 'No description';
            
            const emailsContainer = document.getElementById('viewListEmails');
            emailsContainer.innerHTML = '';
            
            if (data.emails && data.emails.length > 0) {
                data.emails.forEach(email => {
                    const emailDiv = document.createElement('div');
                    emailDiv.className = 'mb-1';
                    emailDiv.textContent = email;
                    emailsContainer.appendChild(emailDiv);
                });
            } else {
                emailsContainer.innerHTML = '<p class="text-muted">No emails found</p>';
            }
            
            new bootstrap.Modal(document.getElementById('viewListModal')).show();
        })
        .catch(error => {
            console.error('Error viewing data list:', error);
            showNotification(error.message, 'error');
        });
}

function editDataList(listId) {
    fetch(`/api/data-lists/${listId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            document.getElementById('editListId').value = data.id;
            document.getElementById('editName').value = data.name;
            document.getElementById('editGeography').value = data.geography || '';
            document.getElementById('editIsp').value = data.isp || '';
            document.getElementById('editDescription').value = data.description || '';
            
            new bootstrap.Modal(document.getElementById('editListModal')).show();
        })
        .catch(error => {
            console.error('Error loading data list for edit:', error);
            showNotification(error.message, 'error');
        });
}

function updateDataList() {
    const listId = document.getElementById('editListId').value;
    const data = {
        name: document.getElementById('editName').value,
        geography: document.getElementById('editGeography').value,
        isp: document.getElementById('editIsp').value,
        description: document.getElementById('editDescription').value
    };
    
    fetch(`/api/data-lists/${listId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        showNotification('Data list updated successfully!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('editListModal')).hide();
        loadDataLists();
    })
    .catch(error => {
        console.error('Error updating data list:', error);
        showNotification(error.message, 'error');
    });
}

function downloadDataList(listId = null) {
    const id = listId || currentViewListId;
    if (!id) return;
    
    window.open(`/api/data-lists/${id}/download`, '_blank');
}

function deleteDataList(listId) {
    if (!confirm('Are you sure you want to delete this data list? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/data-lists/${listId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        showNotification('Data list deleted successfully!', 'success');
        loadDataLists();
    })
    .catch(error => {
        console.error('Error deleting data list:', error);
        showNotification(error.message, 'error');
    });
}

function formatDate(dateString) {
    if (!dateString) return 'Unknown';
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

function showNotification(message, type = 'info') {
    // Use the existing notification system
    if (typeof showToast === 'function') {
        showToast(message, type);
    } else {
        alert(message);
    }
}
</script>
{% endblock %} 