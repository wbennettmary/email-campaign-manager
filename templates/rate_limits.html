{% extends "base.html" %}

{% block title %}Rate Limiting Configuration{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-tachometer-alt text-primary"></i>
            Rate Limiting Configuration
        </h1>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="loadCurrentConfig()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button class="btn btn-outline-warning" onclick="resetToDefaults()">
                <i class="fas fa-undo"></i> Reset to Defaults
            </button>
        </div>
    </div>

    <!-- Current Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar"></i> Current Usage Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center" id="stats-container">
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h4 class="text-primary mb-0" id="daily-sent">-</h4>
                                <small class="text-muted">Daily Sent</small>
                                <div class="progress mt-2" style="height: 5px;">
                                    <div class="progress-bar" id="daily-progress" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h4 class="text-info mb-0" id="hourly-sent">-</h4>
                                <small class="text-muted">Hourly Sent</small>
                                <div class="progress mt-2" style="height: 5px;">
                                    <div class="progress-bar bg-info" id="hourly-progress" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h4 class="text-warning mb-0" id="minute-sent">-</h4>
                                <small class="text-muted">Minute Sent</small>
                                <div class="progress mt-2" style="height: 5px;">
                                    <div class="progress-bar bg-warning" id="minute-progress" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h4 class="text-success mb-0" id="burst-count">-</h4>
                                <small class="text-muted">Burst Count</small>
                                <div class="progress mt-2" style="height: 5px;">
                                    <div class="progress-bar bg-success" id="burst-progress" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cog"></i> Rate Limiting Settings
                    </h5>
                </div>
                <div class="card-body">
                    <form id="rateLimitForm">
                        <!-- Enable/Disable -->
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enabled" checked>
                                <label class="form-check-label" for="enabled">
                                    <strong>Enable Rate Limiting</strong>
                                </label>
                                <div class="form-text">When disabled, no rate limits will be applied</div>
                            </div>
                        </div>

                        <hr>

                        <!-- Email Limits -->
                        <h6 class="mb-3">
                            <i class="fas fa-envelope"></i> Email Sending Limits
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="emails_per_second" class="form-label">Emails per Second</label>
                                    <input type="number" class="form-control" id="emails_per_second" min="0.1" step="0.1" required>
                                    <div class="form-text">Maximum emails that can be sent per second</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="emails_per_minute" class="form-label">Emails per Minute</label>
                                    <input type="number" class="form-control" id="emails_per_minute" min="1" required>
                                    <div class="form-text">Maximum emails that can be sent per minute</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="emails_per_hour" class="form-label">Emails per Hour</label>
                                    <input type="number" class="form-control" id="emails_per_hour" min="1" required>
                                    <div class="form-text">Maximum emails that can be sent per hour</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="emails_per_day" class="form-label">Emails per Day</label>
                                    <input type="number" class="form-control" id="emails_per_day" min="1" required>
                                    <div class="form-text">Maximum emails that can be sent per day</div>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- Timing Settings -->
                        <h6 class="mb-3">
                            <i class="fas fa-clock"></i> Timing Settings
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="wait_time_between_emails" class="form-label">Wait Time Between Emails (seconds)</label>
                                    <input type="number" class="form-control" id="wait_time_between_emails" min="0.1" step="0.1" required>
                                    <div class="form-text">Minimum time to wait between sending emails</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="burst_limit" class="form-label">Burst Limit</label>
                                    <input type="number" class="form-control" id="burst_limit" min="1" required>
                                    <div class="form-text">Number of emails before triggering cooldown</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="cooldown_period" class="form-label">Cooldown Period (seconds)</label>
                                    <input type="number" class="form-control" id="cooldown_period" min="1" required>
                                    <div class="form-text">Time to wait after burst limit is reached</div>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Configuration
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="loadCurrentConfig()">
                                <i class="fas fa-undo"></i> Cancel Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Preset Configurations -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-preset-bottle"></i> Preset Configurations
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="loadPreset('conservative')">
                            <i class="fas fa-shield-alt"></i> Conservative
                            <br><small>1 email/sec, 1s wait, 5s cooldown</small>
                        </button>
                        <button class="btn btn-outline-success" onclick="loadPreset('balanced')">
                            <i class="fas fa-balance-scale"></i> Balanced
                            <br><small>2 emails/sec, 0.5s wait, 3s cooldown</small>
                        </button>
                        <button class="btn btn-outline-warning" onclick="loadPreset('aggressive')">
                            <i class="fas fa-rocket"></i> Aggressive
                            <br><small>5 emails/sec, 0.2s wait, 2s cooldown</small>
                        </button>
                        <button class="btn btn-outline-danger" onclick="loadPreset('custom')">
                            <i class="fas fa-cogs"></i> Custom
                            <br><small>Set your own values</small>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Information Panel -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i> Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-lightbulb"></i> Tips:</h6>
                        <ul class="mb-0">
                            <li>Start with conservative settings</li>
                            <li>Monitor delivery success rates</li>
                            <li>Adjust based on your Zoho account limits</li>
                            <li>Higher limits may trigger spam filters</li>
                        </ul>
                    </div>
                    
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle"></i> Warning:</h6>
                        <ul class="mb-0">
                            <li>Aggressive settings may cause delivery issues</li>
                            <li>Zoho has their own rate limits</li>
                            <li>Test with small campaigns first</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="notification-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-bell text-primary me-2"></i>
            <strong class="me-auto">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-message">
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load configuration when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadCurrentConfig();
    loadStats();
    
    // Auto-refresh stats every 30 seconds
    setInterval(loadStats, 30000);
});

// Form submission
document.getElementById('rateLimitForm').addEventListener('submit', function(e) {
    e.preventDefault();
    saveConfiguration();
});

function loadCurrentConfig() {
    fetch('/api/rate-limits')
        .then(response => response.json())
        .then(config => {
            document.getElementById('enabled').checked = config.enabled;
            document.getElementById('emails_per_second').value = config.emails_per_second;
            document.getElementById('emails_per_minute').value = config.emails_per_minute;
            document.getElementById('emails_per_hour').value = config.emails_per_hour;
            document.getElementById('emails_per_day').value = config.emails_per_day;
            document.getElementById('wait_time_between_emails').value = config.wait_time_between_emails;
            document.getElementById('burst_limit').value = config.burst_limit;
            document.getElementById('cooldown_period').value = config.cooldown_period;
        })
        .catch(error => {
            console.error('Error loading configuration:', error);
            showNotification('Error loading configuration', 'error');
        });
}

function saveConfiguration() {
    const config = {
        enabled: document.getElementById('enabled').checked,
        emails_per_second: parseFloat(document.getElementById('emails_per_second').value),
        emails_per_minute: parseInt(document.getElementById('emails_per_minute').value),
        emails_per_hour: parseInt(document.getElementById('emails_per_hour').value),
        emails_per_day: parseInt(document.getElementById('emails_per_day').value),
        wait_time_between_emails: parseFloat(document.getElementById('wait_time_between_emails').value),
        burst_limit: parseInt(document.getElementById('burst_limit').value),
        cooldown_period: parseInt(document.getElementById('cooldown_period').value)
    };

    fetch('/api/rate-limits', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Configuration saved successfully!', 'success');
        } else {
            showNotification('Error saving configuration: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error saving configuration:', error);
        showNotification('Error saving configuration', 'error');
    });
}

function resetToDefaults() {
    if (confirm('Are you sure you want to reset to default settings? This cannot be undone.')) {
        fetch('/api/rate-limits/reset', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Configuration reset to defaults!', 'success');
                loadCurrentConfig();
            } else {
                showNotification('Error resetting configuration: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error resetting configuration:', error);
            showNotification('Error resetting configuration', 'error');
        });
    }
}

function loadStats() {
    fetch('/api/rate-limits/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.stats;
                
                // Update daily stats
                document.getElementById('daily-sent').textContent = stats.daily_sent;
                const dailyProgress = (stats.daily_sent / stats.daily_limit) * 100;
                document.getElementById('daily-progress').style.width = Math.min(dailyProgress, 100) + '%';
                document.getElementById('daily-progress').className = dailyProgress > 80 ? 'progress-bar bg-danger' : 'progress-bar bg-primary';
                
                // Update hourly stats
                document.getElementById('hourly-sent').textContent = stats.hourly_sent;
                const hourlyProgress = (stats.hourly_sent / stats.hourly_limit) * 100;
                document.getElementById('hourly-progress').style.width = Math.min(hourlyProgress, 100) + '%';
                document.getElementById('hourly-progress').className = hourlyProgress > 80 ? 'progress-bar bg-danger' : 'progress-bar bg-info';
                
                // Update minute stats
                document.getElementById('minute-sent').textContent = stats.minute_sent;
                const minuteProgress = (stats.minute_sent / stats.minute_limit) * 100;
                document.getElementById('minute-progress').style.width = Math.min(minuteProgress, 100) + '%';
                document.getElementById('minute-progress').className = minuteProgress > 80 ? 'progress-bar bg-danger' : 'progress-bar bg-warning';
                
                // Update burst stats
                document.getElementById('burst-count').textContent = stats.burst_count;
                const burstProgress = (stats.burst_count / stats.burst_limit) * 100;
                document.getElementById('burst-progress').style.width = Math.min(burstProgress, 100) + '%';
                document.getElementById('burst-progress').className = burstProgress > 80 ? 'progress-bar bg-danger' : 'progress-bar bg-success';
            }
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
}

function loadPreset(preset) {
    let config = {};
    
    switch(preset) {
        case 'conservative':
            config = {
                enabled: true,
                emails_per_second: 1,
                emails_per_minute: 50,
                emails_per_hour: 500,
                emails_per_day: 5000,
                wait_time_between_emails: 1.0,
                burst_limit: 10,
                cooldown_period: 5
            };
            break;
        case 'balanced':
            config = {
                enabled: true,
                emails_per_second: 2,
                emails_per_minute: 100,
                emails_per_hour: 1000,
                emails_per_day: 10000,
                wait_time_between_emails: 0.5,
                burst_limit: 15,
                cooldown_period: 3
            };
            break;
        case 'aggressive':
            config = {
                enabled: true,
                emails_per_second: 5,
                emails_per_minute: 200,
                emails_per_hour: 2000,
                emails_per_day: 20000,
                wait_time_between_emails: 0.2,
                burst_limit: 20,
                cooldown_period: 2
            };
            break;
        case 'custom':
            // Don't change anything, let user set custom values
            showNotification('Set your custom values in the form above', 'info');
            return;
    }
    
    // Apply the preset
    document.getElementById('enabled').checked = config.enabled;
    document.getElementById('emails_per_second').value = config.emails_per_second;
    document.getElementById('emails_per_minute').value = config.emails_per_minute;
    document.getElementById('emails_per_hour').value = config.emails_per_hour;
    document.getElementById('emails_per_day').value = config.emails_per_day;
    document.getElementById('wait_time_between_emails').value = config.wait_time_between_emails;
    document.getElementById('burst_limit').value = config.burst_limit;
    document.getElementById('cooldown_period').value = config.cooldown_period;
    
    showNotification(`Loaded ${preset} preset configuration`, 'success');
}

function showNotification(message, type) {
    const toast = document.getElementById('notification-toast');
    const toastMessage = document.getElementById('toast-message');
    
    toastMessage.textContent = message;
    toast.className = `toast ${type === 'error' ? 'bg-danger text-white' : type === 'success' ? 'bg-success text-white' : 'bg-info text-white'}`;
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}
</script>
{% endblock %}